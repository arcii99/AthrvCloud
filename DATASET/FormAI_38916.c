//FormAI DATASET v1.0 Category: Public-Key Algorithm Implementation ; Style: portable
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <time.h>

typedef struct {
    int x, y;
} Point;

typedef struct {
    int a, b, p;
} Curve;

typedef struct {
    Curve curve;
    Point G;
    int n;
} ECC_Params;

int gcd(int a, int b) {
    if (a == 0) return b;
    return gcd(b % a, a);
}

int mod_inverse(int a, int m) {
    int m0 = m, t, q;
    int x0 = 0, x1 = 1;

    if (m == 1) return 0;

    while (a > 1) {
        q = a / m;
        t = m;
        m = a % m, a = t;
        t = x0;
        x0 = x1 - q * x0;
        x1 = t;
    }

    if (x1 < 0) {
        x1 += m0;
    }

    return x1;
}

void ecc_generate_key_pair(ECC_Params params, Point d, Point *Q) {
    int k = rand() % (params.n - 1) + 1;

    Point P = params.G;
    Point R = P;

    while (k > 0) {
        if (k & 1) {
            R.x = P.x + R.x;
            R.y = P.y + R.y;
        }

        P.x = P.x + P.x;
        P.y = P.y + P.y;

        k >>= 1;
    }

    Q->x = R.x;
    Q->y = R.y;
}

void ecc_encrypt(ECC_Params params, Point M, Point Q, Point *C1, Point *C2) {
    int k = rand() % (params.n - 1) + 1;

    Point P = params.G;
    Point R = P;

    while (k > 0) {
        if (k & 1) {
            R.x = P.x + R.x;
            R.y = P.y + R.y;
        }

        P.x = P.x + P.x;
        P.y = P.y + P.y;

        k >>= 1;
    }

    C1->x = R.x;
    C1->y = R.y;

    R.x = Q.x + P.x * M.x;
    R.y = Q.y + P.y * M.x;

    C2->x = R.x;
    C2->y = R.y;
}

void ecc_decrypt(ECC_Params params, Point d, Point C1, Point C2, Point *M) {
    Point P = C1;
    Point Q = params.G;
    Point R = Q;

    int k = d.x;

    while (k > 0) {
        if (k & 1) {
            R.x = Q.x + R.x;
            R.y = Q.y + R.y;
        }

        Q.x = Q.x + Q.x;
        Q.y = Q.y + Q.y;

        k >>= 1;
    }

    Q = R;
    Q.y = -Q.y;

    int m_x = mod_inverse(P.x, params.curve.p);
    int m = m_x * P.y % params.curve.p;

    M->x = (C2.y * m) % params.curve.p;
}

int main() {
    srand(time(NULL));

    // Example parameters for an elliptic curve
    ECC_Params params;
    params.curve.a = 0;
    params.curve.b = 7;
    params.curve.p = 97;
    params.G.x = 47;
    params.G.y = 71;
    params.n = 17;  // order of the group generated by G

    // Generate a random private key
    Point d;
    d.x = rand() % (params.n - 1) + 1;

    // Compute public key
    Point Q;
    ecc_generate_key_pair(params, d, &Q);

    // Encrypt a message
    Point M;
    M.x = 13;
    Point C1, C2;
    ecc_encrypt(params, M, Q, &C1, &C2);

    // Decrypt the message
    Point M2;
    ecc_decrypt(params, d, C1, C2, &M2);

    // Check that decryption worked
    printf("Original message: (%d, %d)\n", M.x, M.y);
    printf("Decrypted message: (%d, %d)\n", M2.x, M2.y);

    return 0;
}