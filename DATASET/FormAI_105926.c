//FormAI DATASET v1.0 Category: Prime Number Generator ; Style: asynchronous
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <pthread.h>
#include <unistd.h>

#define MAX_PRIME_NUM 5000 // the maximum number of prime numbers we want to generate
#define MAX_THREADS 20 // the maximum number of threads we want to use

bool prime[MAX_PRIME_NUM + 1]; // an array to store whether a number is prime or not
int prime_numbers[MAX_PRIME_NUM]; // an array to store the prime numbers we generate
int num_threads = 0; // the number of threads currently running

// A function to check whether a number is prime or not
bool is_prime(int n) {
    if(n <= 1) {
        return false;
    }
    for(int i = 2; i * i <= n; i++) {
        if(n % i == 0) {
            return false;
        }
    }
    return true;
}

// A function for our threads to execute
void* thread_function(void* arg) {
    int* thread_num_ptr = (int*) arg; // get the thread number
    int thread_num = *thread_num_ptr;

    printf("Thread %d started\n", thread_num);

    int start = (thread_num - 1) * (MAX_PRIME_NUM / num_threads); // calculate the start and end points for this thread
    int end = thread_num == num_threads ? MAX_PRIME_NUM : thread_num * (MAX_PRIME_NUM / num_threads);

    for(int i = start; i < end; i++) { // loop through the section of the prime array assigned to this thread
        if(is_prime(i)) { // if the number is prime, add it to the prime_numbers array
            prime_numbers[i] = i;
        }
    }

    printf("Thread %d finished\n", thread_num);
    free(thread_num_ptr);

    return NULL;
}

int main() {
    for(int i = 2; i <= MAX_PRIME_NUM; i++) { // initialize the prime array
        prime[i] = true;
    }

    for(int i = 2; i * i <= MAX_PRIME_NUM; i++) { // sieve of eratosthenes
        if(prime[i]) {
            for(int j = i * i; j <= MAX_PRIME_NUM; j += i) {
                prime[j] = false;
            }
        }
    }

    pthread_t threads[MAX_THREADS]; // create an array of thread ids
    int thread_args[MAX_THREADS]; // create an array to store the thread arguments

    for(int i = 1; i <= MAX_THREADS; i++) { // create and run the threads
        if(num_threads == MAX_THREADS) { // if we've reached the maximum number of threads, wait for them to finish before creating more
            for(int j = 0; j < num_threads; j++) {
                pthread_join(threads[j], NULL);
            }
            num_threads = 0;
        }

        int* arg = malloc(sizeof(*arg)); // create the argument for the thread
        *arg = i;

        if(pthread_create(&threads[num_threads], NULL, thread_function, arg)) { // create the thread
            printf("Error creating thread %d\n", i);
            return 1;
        }
        num_threads++;
    }

    for(int i = 0; i < num_threads; i++) { // wait for all the threads to finish
        pthread_join(threads[i], NULL);
    }

    printf("\n\nPrime numbers generated by asynchronous threads:\n");
    for(int i = 0; i < MAX_PRIME_NUM; i++) { // print out the prime numbers
        if(prime_numbers[i] != 0) {
            printf("%d ", prime_numbers[i]);
        }
    }
    printf("\n");

    return 0;
}